<!DOCTYPE html>
<meta charset="utf-8">
<title>animas</title>
<head >

  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
    div#fps,svg { position: fixed; top:0; left:0; color: white; }
  </style>

</head>
<body style="cursor:crosshair"></body>
<div id="viewframe" class="viewframe"></div>

<script src="enls.js"></script>
<script src="ents.js"></script>

<script>

let muonAlima = function (__mapper) {
  __mapper({"xs": xs.xs(__mapper)})               // PROXIES
  __mapper("xs").b("init")({svg:1,versor:0,wen:0,webgl:1, key:1,})  // INIT

  let f = __mapper({"props": muonProps.muonProps()}).props()
  let mgeom = __mapper("xs").m("geom")
  let mwen = __mapper("xs").m("wen")
  let mmouse = __mapper("xs").m("mouse")

  let r = __mapper("xs").r("renderer"),
    width = r.width(),
    height = r.height()


    if (__mapper("controlKey") !== undefined) {
         let controltimerLeftArrowAlt = () => {       // LEFT ARROW

          if (__mapper("muonAnimation").animationStop !== undefined) {
               console.log("controltimerLeftArrowAlt")
            if (__mapper("controlTimer").started()) {
              __mapper("controlTimer").stop()
            } else {
              __mapper("controlTimer").resume()
            }
          }
        }
        __mapper("controlKey").subscribe(controltimerLeftArrowAlt, "leftArrowAlt")
     }


    if (__mapper("controlKey") !== undefined) {
         let controltimerUpArrowAlt = () => {         // UP ARROW

            console.log("controltimerUpArrowAlt")
            __mapper("controlWen").control(__mapper("renderSVG").svg())    // SVG WEN

        }
        __mapper("controlKey").subscribe(controltimerUpArrowAlt, "upArrowAlt")
     }


  /*******************************************
 *    	@pics
 *
 */

  let tim = {"td":52800,"t0":0,"t1":1000,"t2":1,"t3":1,}


  /*******************************************
 *    	@animas
 *
 */


  // -------------------------------  pointform
  let pointform = {

    "halo": "pacer",

    "payload": {

			"tim": tim,
			"ric": {"gid":"nat","cid":"nat","fid":"nat",},
			"boform": { "csx":0,"cf":[[[444,999]]], "co":[[[0.9,0.9]]], "cs":[[[555,999]]],"cw":[[[2.7,2.7]]],"cp":[[[0.9,0.9]]],},

			"proform": {
					"projection": "uniwen",
					"transpose":  [ 0, 0, 0],
					"translate":  {"x": 0, "y": 0, "z": 0, },
					"scale": 1,
					"rotate": [0,0,0],
					"focale": Infinity,
					"zafin": [0,1],
					"dims": 3,
					"control": "wen",
			},

			pacer: {
        "initN": 0,
        "eventN": 1,
        "autoN": 0,
        "autoP": 0.1,
        "outed": 0,
        "maxN": 60,
        "span": 15 / 1400,
				
				initSitus: d => ({x: width / 2, y: height / 2, z: 0 }),
				eventSitus: d => ({x: mmouse.event().x, y: mmouse.event().y, z: 0 }),
				autoSitus: d => mstace.getLocus(d),
				
				geometrier: point => ({type: "Point", coordinates: Object.values(point),}),
				
      }
			
			
			
    }

  }

/*******************************************
 * 			@forces
 *
 */
	 // force_energy
	let  force_energy = {
			"pic": {
				alpha: 1 ,
				alphaMin: 0.001,
				alphaDecay: 0,
				alphaTarget: 0,
			},


			"field":  function field (params = {}) {


				let nodes = params.nodes
				let forces = []

				let forceParams =  {
						"type": "energy",
						"filter": d => true,
						"src": d3_force,
						"nodes": nodes,
					}

				let  field = 	{
						"key": "energy",
						"force": __mapper("xs").m("forces").force(forceParams)

					}

				forces.push(field)

				return forces

			}
		}
		// force_viscosity
	let  force_viscosity = {
			"pic": {
				velocityDecay: 0.0002,
			},

			"field":  function field (params = {}) {

				let nodes = params.nodes

				let forces = []

				let forceParams =  {
						"type": "noforce",
						"filter": d => true,
						"src": d3_force,
						"nodes": nodes,
				}

				let  field = 	{
						"key": "viscosity",
						"force": __mapper("xs").m("forces").force(forceParams)
				}

				forces.push(field)

				return forces

			}
		}
		// force_manybody
		let  force_manybody = {
		"pic": {
			"charge": -1.9,
		},

		"field":   params => {

			let nodes = params.nodes
			let forces = []

			let charge = params.pic.charge

			let forceParams =  {
					type: "manybody",
					strength: charge,
					filter: d => d.payload.ric.gid === "nat",
					dim: 2,
					src: d3_force,		// d3
					nodes: nodes,
				}

			let  field = 	{

				"key": "charge",
				"force": __mapper("xs").m("forces").force(forceParams)

			}
			forces.push(field)
			return forces

		}
	}
		// force_manybody
let forceGravity = function forceGravity(params) {

  let nodes = params.nodes
	let newNodes = []


	let gravity = (params.gravity !== undefined) ? params.gravity : 0.6

	function force() {
		if (0 & 1) console.log("force gravity")
		for (let i = 0; i < nodes.length; ++i) {

				let node = nodes[i]
				node.vy += gravity		// node.vx += 0.001 * Math.random()

		}
  }

	function initialize() {
    if (!nodes) return
  }

	return force
}

	let  force_gravity = {
		"pic": {

			"gravity": 0.001 ,

		},


		"field":   params => {

			let nodes = params.nodes
			let forces = []

			let gravity = params.pic.gravity

			let forceParams =  {
					type: "gravity",
					gravity: gravity,
					filter: d => d.payload.ric.gid === "nat" || d.payload.ric.gid === "nat",
										dim: 2,
					src: d3_force,
					nodes: nodes.filter(d => d.payload.ric.gid === "nat" || d.payload.ric.gid === "nat"),
				}

			let  field = 	{

					"key": "gravity",
					"force": forceGravity(forceParams)

			}
			forces.push(field)
			return forces

		}
	}
	

  /*******************************************
 * @animaApi
 *
 */
		pointform.payload.forces = {
			force_energy,
			force_viscosity,
			force_manybody,
			force_gravity,
		}

  let animas = [
    pointform,     // h.pointer

  ]

  let animaApi = function animaApi() {

    __mapper("xs").m("store").apply({"type":"UPDANIMA","caller":"alima","animas":animas})

  }

  return animaApi

}

let __mapper = bosonMapper.bosonMapper()
__mapper({"muonAlima": muonAlima(__mapper)}).muonAlima(__mapper)
</script>
<body style="cursor:crosshair"></body>
