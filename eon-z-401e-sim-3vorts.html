<script src="eon-x-eonify.js"></script>
<script>
window.xEonify.eon({anitem, time: undefined})

// ... (\r\n){1,}
// ... \r\n

// .................. anitem
async function anitem (__mapper) {
  let [
    d3Geo,
    d3Force3d,
    ctlRayder,
    ctlWen,
    eohalCore,
    eohalLinkform,
    eohalNatform,
    eohalMars,
    muonEoric,
    muonEoforces,
    muonGeom,
    muonNatform,
    muonProps,
    renderPortview,
    renderSvg,  
  ] = await Promise.all([
    __mapper('xs').b('d3-geo'),
    __mapper('xs').b('d3-force-3d'),
    __mapper('xs').c('rayder'),
    __mapper('xs').c('wen'),
    __mapper('xs').e('core'),
    __mapper('xs').e('linkform'),
    __mapper('xs').e('natform'),
    __mapper('xs').e('mars'),
    __mapper('xs').m('eoric'),
    __mapper('xs').m('eoforces'),
    __mapper('xs').m('geom'),
    __mapper('xs').m('natform'),
    __mapper('xs').m('props'),
    __mapper('xs').r('portview'),
    __mapper('xs').r('svg'), 
  ])

  let [
    forceVoid,
    forceEnergy,
    // forceViscosity,
    forceManybody,
    // forceGravity,
    // forceCharge,
    // forceCube,
    forceCollide,
    forceLink,
    // forceX,
    // forceY,
    // forceZ,
  ] = await Promise.all([
    __mapper('xs').f('void'),
    __mapper('xs').f('energy'),
    // __mapper('xs').f('viscosity'),
    __mapper('xs').f('manybody'),
    // __mapper('xs').f('gravity'),
    // __mapper('xs').f('charge'),
    // __mapper('xs').f('cube'),
    __mapper('xs').f('collide'),
    __mapper('xs').f('link'),
    // __mapper('xs').f('x'),
    // __mapper('xs').f('y'),
    // __mapper('xs').f('z'),
  ])

  let muonStore = __mapper('muonStore')
  let d3_force = d3Force3d

  // ............................. nuid
  let nuid = i => {
    let eoric = { gid: 'node', cid: 'node', fid: 'node' + i }
    eoric.uid = muonEoric.getuid(eoric)
    return eoric
  }

  // ............................. luid
  let luid = i => {
    let eoric = { gid: 'link', cid: 'link', fid: 'link' + i }
    eoric.uid = muonEoric.getuid(eoric)
    return eoric
  }

  var data = {
    'nodes': [
      [31 + -144, 30 + 138, 0], // 00
      [31 + 82, 30 + 137, 0], // 01
      [31 + 82, 30 + -155, 0], // 02
      [31 + -145, 30 + -155, 0], // 03
      [31 + -89, 30 + 35, 0], // 04
      [31 + -80, 30 + 42, 0], // 05
      [31 + -71, 30 + 43, 0], // 06
      [31 + -62, 30 + 42, 0], // 07
      [31 + -52, 30 + 38, 0], // 08
      [31 + -10, 30 + 35, 0], // 09
      [31 + -1, 30 + 40, 0], // 10
      [31 + 9, 30 + 42, 0], // 11
      [31 + 19, 30 + 39, 0], // 12
      [31 + 25, 30 + 34, 0], // 13
      [31 + -86, 30 + 10, 0], // 14
      [31 + -69, 30 + 19, 0], // 15
      [31 + -51, 30 + 7, 0], // 16
      [31 + -68, 30 + -1, 0], // 17
      [31 + -67, 30 + 12, 0], // 18
      [31 + -12, 30 + 8, 0], // 19
      [31 + 8, 30 + 21, 0], // 20
      [31 + 23, 30 + 11, 0], // 21
      [31 + 8, 30 + -1, 0], // 22
      [31 + 9, 30 + 12, 0], // 23
      [31 + -48, 30 + -53, 0], // 24
      [31 + -41, 30 + -48, 0], // 25
      [31 + -33, 30 + -54, 0], // 26
      [31 + -22, 30 + -48, 0], // 27
      [31 + -16, 30 + -54, 0], // 28
      [31 + -59, 30 + -91, 0], // 29
      [31 + -41, 30 + -95, 0], // 30
      [31 + -32, 30 + -93, 0], // 31
      [31 + -20, 30 + -93, 0], // 32
      [31 + -3, 30 + -91, 0], // 33
      [31 + -101, 30 + -55, 0], // 34
      [31 + -96, 30 + -79, 0], // 35
      [31 + -89, 30 + -104, 0], // 36
      [31 + -78, 30 + -120, 0], // 37
      [31 + -62, 30 + -135, 0], // 38
      [31 + -35, 30 + -151, 0], // 39
      [31 + -3, 30 + -141, 0], // 40
      [31 + 13, 30 + -131, 0], // 41
      [31 + 24, 30 + -109, 0], // 42
      [31 + 40, 30 + -61, 0], // 43

      [31 + -31, 30 + 36, 0], // 44
      [31 + -32, 30 + 7, 0], // 45

    ],
    'links': [
      // [0, 1],
      // [0, 3],
      // [0, 4],
      // [0, 5],
      // [0, 6],
      // [0, 7],
      // [0, 34],
      // [1, 2],

      // [1, 10],  // [1,7],
      // [1, 11],
      // [1, 12],
      // [1, 13],
      // [1, 21],
      // [1, 43],
      // [2, 3],
      // [2, 39],
      // [2, 40],
      // [2, 41],
      // [2, 42],
      // [2, 43],
      // [3, 34],
      // [3, 35],
      // [3, 36],
      // [3, 37],
      // [3, 38],
      // [3, 39],
      [4, 5],
      [4, 14],
      [4, 15],
      [4, 34],
      [5, 6],
      [5, 15],
      [6, 7],
      [6, 15],
      [7, 8],
      // [7,10],
      [7, 15],
      // [8,9],
      // [8,10],
      [8, 15],
      [8, 16],
      [9, 10],
      // [9,16],
      [9, 19],
      [9, 20],
      [10, 11],
      [10, 20],
      [11, 12],
      [11, 20],
      [12, 13],
      [12, 20],
      [13, 20],
      [13, 21],
      [13, 43],
      [14, 15],
      [14, 17],
      [14, 18],
      [14, 34],
      [15, 16],
      [15, 18],
      [16, 17],
      [16, 18],
      // [16,19],
      [16, 25],
      [17, 18],
      [17, 24],
      [17, 25],
      [17, 34],
      [19, 20],
      [19, 22],
      [19, 23],
      // [19,25],
      [19, 27],
      [20, 21],
      [20, 23],
      [21, 22],
      [21, 23],
      [21, 43],
      [22, 23],
      [22, 27],
      [22, 28],
      [22, 43],
      [24, 25],
      [24, 26],
      [24, 29],
      [24, 30],
      [24, 34],
      [24, 35],
      [25, 26],
      [25, 27],
      [26, 27],
      [26, 28],
      [26, 30],
      [26, 31],
      [26, 32],
      [27, 28],
      [28, 32],
      [28, 33],
      [28, 43],
      [29, 30],
      [29, 35],
      [29, 36],
      [29, 37],
      [29, 38],
      [30, 31],
      [30, 38],
      [30, 39],
      [31, 32],
      [31, 39],
      [32, 33],
      [32, 39],
      [32, 40],
      [33, 40],
      [33, 41],
      [33, 42],
      [33, 43],
      [34, 35],
      [35, 36],
      [36, 37],
      [37, 38],
      [38, 39],
      [39, 40],
      [40, 41],
      [41, 42],
      [42, 43],

      // [0, 8],
      // [0, 44],
      // [1, 9],
      // [1, 44],

      [8, 44],
      [8, 45],
      [9, 44],
      [9, 45],
      [16, 45],
      [19, 45],
      [25, 45],
      [27, 45],
      [44, 45],

    ],
  }

  // .................. animas
  let ani = function () {
    // .................... pics
    let eotim = {'td': 12800, 't0': 0, 't1': 1000, 't2': 1, 't3': 1, tf: t => (1 / Math.PI) * ((Math.PI / 2) + Math.arcsin(-1 + 2 * t))}

    // ............................. eohale
    let eohale = anima => {
      if (!anima.eogelded) {
        let animas = []
        let nodes = []
        let links = []

        let fieldAni = {

          eohal: 'core',
          eotim: eotim,
          eoric: {gid: 'field', cid: 'field', fid: 'field'},
          eofold: null,
          eoload: {},

        }
        fieldAni.eoforces = {
          force_link,
          force_gravity,
        }

        animas.push(fieldAni)

        for (var i = 0; i < data.nodes.length; i++) {
          let node = {
            x: data.nodes[i][0],
            y: data.nodes[i][1],
            z: data.nodes[i][2],
          }
          nodes.push(node)

          let ani = muonProps.cloneObj(anima)
          ani.eohal = 'mars'
          ani.eoric = nuid(i)
          ani.eonode.geometry.coordinates = Object.values(node)
          ani.eocrom = { 'csx': 0, 'cf': 888, 'co': 0.5, 'cs': 666, 'cw': 0.9, 'cp': 0.8 }

          animas.push(ani)
        }
        for (var i = 0; i < data.links.length; i++) {
          let nidfrom = data.links[i][0]
          let nidto = data.links[i][1]

          let line = {}
          line.userData = {
            source: data.links[i][0],
            target: data.links[i][1],
          }

          let dist = muonGeom.distance(
            data.nodes[data.links[i][0]][0],
            data.nodes[data.links[i][0]][1],
            data.nodes[data.links[i][1]][0],
            data.nodes[data.links[i][1]][1]
          )
          let linkForcePar = 0.01
          let linkForce = dist * linkForcePar

          let ani = muonProps.cloneObj(anima)
          ani.eohal = 'linkform'
          ani.eoric = luid(i)
          ani.eocrom = { 'csx': 0, 'cf': 888, 'co': 0.5, 'cs': 666, 'cw': 0.9, 'cp': 0.8 }
          ani.eoload = {}
          ani.eoload.link = {
            source: nuid(nidfrom).uid,
            target: nuid(nidto).uid,
          }

          animas.push(ani)
        }

        // ... org anima is becomes gelded after halo ween
        // ... org anima is becomes delled after halo ween

        updanima = muonProps.cloneObj(anima)
        updanima.eogelded = 1
        updanima.eodelled = 1
        animas.push(updanima)

        muonStore.apply({
          type: 'UPDANIMA',
          caller: 'h.ineohal',
          animas: animas,
        })

        return animas
      }
    }

    let eohal_ween = anitem => eohale(anitem)
    let eohal_gramm = anitem => anitem

    let ineohal = {
      ween: anitem => eohal_ween(anitem),
      gramm: anitem => eohal_gramm(anitem),
    }

    // .................... natVort
    let natVort = {

      eohal: ineohal,

      eotim: eotim,
      eoric: {gid: 'g', cid: 'g', fid: 'g'},

      eofold: {
        type: 'Feature',
        geometry: {
          type: 'Point',
          coordinates: [0, 0, 0],
        },
        properties: {},
      },

      eonode: {
        type: 'Feature',
        geometry: {
          type: 'Point',
          coordinates: [0, 0, 0],
        },
        properties: {
          orgen: [0, 0, 0], velin: [0, 0, 0], prevous: [0, 0, 0], geodelta: [0, 0, 0],
        },
      },

      eomot: {

        proform: {
          projection: 'uniwen',
          prerotate: [[[ ctlWen.rotation ]]],
          translate: [0, 0, 0],
          scale: 1,
          rotate: [ [[[0, 360]]], [[[0, 360]]], 0 ],
          lens: [0, 1, Infinity],
          geoanod: 1,
        },

      },

      eocrom: { 'csx': 0, 'cf': 888, 'co': 0.5, 'cs': 666, 'cw': 0.9, 'cp': 0.8 },
      eoform: {},
      eoload: {},
    }

    // ............................. force_energy
    let force_energy = { // aniForce
      properties: {
        alpha: 1,
        alphaMin: 0.001,
        alphaDecay: 0,
        alphaTarget: 0,
      },

      field: function field (params = {}) {
        let forces = []
        let nodes = params.nodes

        let forceParams = {
          type: 'energy',
          src: d3_force,
          nodes: nodes,
          filter: d => d.eoric.gid === 'ani',
          key: 'energy',
        }

        let force = muonEoforces.force(forceParams)
        forces.push(force)
        return forces
      },
    }

    // ............................. force_collide
    let force_collide = {

      properties: {
        strength: 0.03,
      },

      field: params => {
        let forces = []

        let nodes = params.nodes

        let strength = params.properties.strength

        let forceParams = {
          type: 'collide',
          src: d3_force,
          nodes: nodes,
          strength: strength,
          radius: d => 90,
          filter: d => d.eoric.gid === 'node',
          key: 'collide',
        }

        let force = muonEoforces.force(forceParams)
        forces.push(force)
        return forces
      },
    }

    // ............................. forceGravity
    // ... muonSim receives field.key key.force objects
    // ... the field object is built in muonEoforces.force
    // ... or in the force object
    let forceGravity = function (params) { // force
      console.assert(params.key !== undefined)
      let nodes = params.nodes
      let newNodes = []

      let gravity = params.gravity

      function force () { // d3force builtin (vs muon d3force)
        for (let i = 0; i < nodes.length; ++i) {
          let node = nodes[i]
          node.vy += gravity // node.vx += 0.001 * Math.random()
        }
      }

      function initialize () {
        if (!nodes) return
      }

      let field = {
        key: params.key,
        force: force,
      }
      return field
    }

    let force_gravity = { // aniForce:{properties, field}
      properties: {
        gravity: -0.07,
      },

      field: params => { // elapsed, nodes, properties.gravity
        let forces = []

        let nodes = params.nodes
        let gravity = params.properties.gravity // params.properties

        let forceParams = {
          type: 'gravity',
          src: d3_force,
          nodes: nodes,
          gravity: gravity,
          filter: d => d.eoric.gid === 'node',
          id: d => d.eoric.uid,
          key: 'gravity',
        }

        let force = forceGravity(forceParams)
        forces.push(force)
        return forces
      },
    }

    // .................... field_link
    let force_link = {
      properties: {
        strength: 1,
      },

      field: params => {
        let forces = []

        let nodes = params.nodes
        let strength = params.strength || params.properties.strength
        let filter = d => true
        let id = d => d.eoric.uid
        let links = params.properties.links || nodes.filter(d => (d.eoric.gid === 'link'))
        let key = params.properties.key || 'link'

        let forceParams = {
          type: 'link',		// key in plugin forces
          src: d3_force,
          nodes: nodes,
          strength: d => strength,
          filter: d => true,
          id: d => d.eoric.uid,
          links: nodes.filter(d => (d.eoric.gid === 'link')),
          key: key,
        }

        let force = muonEoforces.force(forceParams)
        forces.push(force)
        return forces
      },
    }

    // ............................. force_manybody
    let force_manybody = { // aniForce

      properties: {
        strength: -1.9,
        theta: 0.9,
        distanceMin: 0,
        distanceMax: Infinity,
      },

      field: params => {
        let forces = []

        let nodes = params.nodes
        let strength = params.properties.strength

        let forceParams = {
          type: 'manybody', // f.manybody
          src: d3_force, // d3
          nodes: nodes,
          strength: strength,
          filter: d => d.eoric.gid === 'node',
          key: 'charge',
        }

        let force = muonEoforces.force(forceParams)
        forces.push(force)
        return forces
      },
    }

    // ............................. force_viscosity
    let force_viscosity = {
      properties: {
        velocityDecay: 0.0002,
      },

      field: function (params = {}) { // field.field
        let forces = []
        let nodes = params.nodes // nodes
        let velocityDecay = params.properties.velocityDecay

        let forceParams = {
          type: 'void',
          src: d3_force,
          filter: d => true,
          velocityDecay: velocityDecay,
          key: 'viscosity',
        }

        let force = muonEoforces.force(forceParams)
        forces.push(force)
        return forces
      },
    }

    // .................... fieldAni
    let fieldAni = {

      eohal: 'core',
      eotim: eotim,
      eoric: {gid: 'field', cid: 'field', fid: 'field'},
      eofold: null,
      eoload: {},

    }

    natVort.eoforces = {
      // force_energy,
      // force_viscosity,
      // force_manybody,
      // force_gravity,
      // force_collide,
      force_link,
    }

    // .................. animas
    let animas = [

      natVort, // h.mars
      // fieldAni, // h.core

    ]

    return animas
  }

  let enty = () => {}
  enty.ani = ani
  return enty
}
</script>