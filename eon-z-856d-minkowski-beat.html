<script src="./d3-require.js"></script>
<script src="./eon-x-eonify.js"></script>

<script>
window.xEonify.eon({anitem, time: undefined})

// .................. anitem
async function anitem (__eo) {
  // .................. eons
  let [
    ctlWen,
    eohalMars,
    muonMinkowski,
    muonProj3ct,
    muonProfier,
    muonCastel,
    renderPortview,
    renderSvg,
  ] = await Promise.all([
    __eo('xs').c('wen'),
    __eo('xs').e('mars'),
    __eo('xs').m('minkowski'),
    __eo('xs').m('proj3ct'),
    __eo('xs').m('profier'),
    __eo('xs').m('castel'),
    __eo('xs').r('portview'),
    __eo('xs').r('svg'),
  ])

  let svgdata1 = {
    width: '364.815mm',
    height: '204.497mm',
    viewBox: '0 0 1379 773',
    path: {
      id: 'path3',
      fill: 'none',
      stroke: 'black',
      // ["stroke-width"]:"1",
      svgdata: '1',
      d: `M 894.78,770.15
           C 898.06,767.80 907.99,677.00 907.99,677.00
             907.99,677.00 901.00,605.00 889.75,579.00
             886.05,567.72 876.00,509.00 876.00,509.00
             875.81,492.82 879.70,466.80 883.75,465.56
             886.90,464.60 896.53,486.18 904.00,487.57
             908.28,488.36 969.00,468.02 969.00,468.02
             985.80,459.89 1001.56,448.21 1017.00,437.77
             1026.11,431.61 1028.07,425.15 1040.00,425.00
             1040.00,425.00 1065.00,425.00 1065.00,425.00
             1074.50,424.89 1087.22,420.81 1096.00,423.30
             1103.40,425.40 1115.37,435.34 1117.40,433.93
             1119.06,432.79 1114.88,416.11 1109.00,413.13
             1104.23,410.72 1092.02,405.39 1087.00,405.11
             1087.00,405.11 1032.62,410.86 1025.00,413.04
             1012.41,416.65 967.00,428.00 967.00,428.00
             957.51,427.95 941.78,425.62 935.53,417.96
             921.33,374.00 918.00,310.67 919.00,284.00
             918.99,276.20 916.92,261.31 912.20,255.09
             909.10,251.01 885.80,240.20 867.00,234.00
             853.82,229.65 831.77,221.73 831.05,205.00
             830.75,198.27 833.46,193.25 841.00,195.08
             849.85,197.24 862.71,206.57 871.91,201.55
             874.91,199.91 884.10,185.41 885.11,182.00
             886.55,177.17 883.80,175.67 888.54,169.00
             888.54,169.00 897.18,158.21 897.18,158.21
             899.96,155.48 903.74,153.97 905.02,149.99
             906.95,144.00 900.62,130.15 900.46,123.00
             900.33,117.38 903.38,113.01 905.10,108.00
             906.82,103.00 907.00,86.00 907.00,86.00
             906.92,69.00 898.49,47.97 887.68,35.00
             880.91,26.88 844.54,1.17 830.00,1.00
             830.00,1.00 781.14,4.20 776.00,4.20
             771.00,14.00 626.00,10.00 626.00,10.00
             617.50,10.01 565.01,15.74 550.00,23.82
             539.79,29.33 512.67,79.94 513.12,86.00
             513.86,96.05 601.00,104.00 601.00,104.00
             623.24,104.10 737.00,79.57 737.00,79.57
             738.88,80.11 768.33,138.88 768.79,142.00
             769.77,148.67 753.05,183.38 747.63,191.00
             744.81,194.96 717.85,214.69 710.00,217.25
             710.00,217.25 652.02,235.33 649.18,237.63
             645.56,240.58 639.56,249.73 637.15,254.00
             630.08,266.55 625.61,280.64 624.04,295.00
             624.04,295.00 624.41,334.45 618.78,336.83
             615.51,338.22 607.12,317.03 605.92,310.00
             605.92,310.00 599.28,270.00 599.28,270.00
             599.28,270.00 594.30,238.94 591.43,231.00
             588.58,223.09 573.09,198.73 567.00,199.49
             561.51,200.18 553.86,208.97 548.57,202.71
             541.03,193.79 558.78,186.57 560.16,181.91
             561.58,177.05 554.97,172.04 551.00,170.70
             542.35,167.78 521.52,175.51 524.56,188.00
             525.42,191.54 534.41,207.01 538.18,210.70
             538.18,210.70 569.96,234.04 569.96,234.04
             583.87,247.89 584.51,259.58 585.82,278.00
             585.82,278.00 579.86,390.00 579.86,390.00
             580.13,404.15 582.95,412.84 587.33,426.00
             587.33,426.00 597.33,464.00 613.00,467.94
             629.93,468.50 640.28,456.34 646.42,442.00
             646.42,442.00 670.93,362.98 673.22,361.91
             690.00,388.00 694.09,470.29 690.25,482.00
             685.18,497.49 668.48,514.82 661.26,530.00
             661.26,530.00 634.19,593.92 631.08,603.00
             630.01,606.10 622.77,655.24 623.01,666.00
             623.01,666.00 630.65,767.07 634.43,770.15
             638.00,767.00 757.00,770.00 756.72,770.15
             760.46,767.34 762.70,727.30 766.01,727.54
             771.77,727.95 771.06,768.80 774.23,770.69
             784.00,770.00 892.00,771.00 894.78,770.15 Z`,
    },
  }

  let svgdata2 = {
    width: '364.815mm',
    height: '204.497mm',
    viewBox: '0 0 1379 773',
    path: {
      id: 'path3',
      fill: 'none',
      stroke: 'black',
      // ["stroke-width"]:"1",
      svgdata: '1',
      d: `M 739.33,2.67
           C 702.67,24.67 706.46,54.99 705.07,58.00
             703.07,62.33 699.21,64.32 697.93,69.00
             699.50,107.33 715.26,108.36 718.36,114.00
             718.36,114.00 722.50,137.67 732.01,150.00
             735.54,157.47 751.50,188.00 740.16,209.61
             737.25,212.45 729.50,213.50 723.41,226.47
             710.50,230.50 691.00,242.00 678.92,260.00
             670.83,281.00 679.42,309.26 679.50,316.00
             668.50,374.00 680.00,376.50 694.51,394.00
             697.87,399.41 702.62,420.17 698.50,429.50
             692.50,446.00 651.01,472.40 627.00,483.50
             601.00,488.00 563.00,488.50 547.61,508.46
             549.48,511.39 577.33,536.64 583.50,536.50
             596.00,519.00 628.17,516.33 643.50,500.91
             652.59,492.47 672.50,484.00 682.00,483.50
             683.50,504.00 665.17,535.33 657.60,547.00
             636.00,573.00 562.65,613.81 546.50,614.00
             522.50,610.00 477.00,625.00 470.93,647.00
             476.50,663.00 501.63,674.12 506.50,674.19
             510.96,674.26 546.50,657.65 546.50,657.65
             546.50,657.65 613.50,610.50 626.00,626.00
             617.97,691.00 623.50,728.00 634.00,763.00
             635.65,764.99 754.50,764.00 754.50,764.00
             754.50,764.00 754.50,729.50 764.00,721.50
             771.50,729.50 769.00,763.50 769.00,763.50
             769.00,763.50 904.50,764.00 904.50,764.00
             909.57,736.16 909.45,736.45 909.50,707.00
             913.50,679.00 911.00,636.00 911.50,635.00
             914.50,612.50 902.85,570.00 902.85,570.00
             906.50,525.50 873.50,484.00 876.00,467.50
             879.00,441.50 900.76,400.59 896.50,348.00
             896.50,348.00 905.00,304.50 897.58,276.00
             898.83,252.33 886.11,188.10 886.69,183.00
             890.53,164.76 900.50,165.00 874.88,142.00
             872.47,138.98 860.50,113.67 860.29,114.00
             845.50,101.67 832.17,76.00 827.96,49.00
             827.96,49.00 812.67,13.33 794.00,3.33
             785.00,2.83 739.33,3.67 739.33,2.67 Z`,
    },
  }

  // .................. animas
  let ani = function () {
    // .................. pics
    let ctl
    try {
      ctl = ctlWen().control(renderSvg.svg())
    } catch (e) {
      ctl = () => [0, 0, 0]
    }

    let eotim = {'td': 9800, 't0': 0, 't1': 1, 't2': 1, 't3': 1}

    let uniframe = {start: 0, stop: 0.9, step: 0.09}
    let gjdata1 = muonCastel.castels(svgdata1, uniframe)
    let svgprj1 = muonCastel.svgprj(svgdata1, renderPortview)

    let proformSvg1 = {
      projection: 'uniwen',
      translate: svgprj1.translate,
      scale: svgprj1.scale,
      rotate: [ 0, 0, 0 ],
      lens: [0, 1, Infinity],
    }
    let geoData1 = muonProj3ct(gjdata1, muonProfier.uniweon(proformSvg1))

    let gjdata2 = muonCastel.castels(svgdata2, uniframe)
    let svgprj2 = muonCastel.svgprj(svgdata2, renderPortview)
    let proformSvg2 = {
      projection: 'uniwen',
      translate: svgprj2.translate,
      scale: svgprj2.scale,
      rotate: [ 0, 0, 0 ],
      lens: [ 0, 1, Infinity ],
    }
    let geoData2 = muonProj3ct(gjdata2, muonProfier.uniweon(proformSvg2))

    // .................. lichtAni1
    let lichtAni1 = {

      eohal: 'mars',
      eotim: eotim,
      eoric: { gid: 'ani', cid: 'ani', fid: 'ani1'},

      eofold: ani => {
        let geoData = geoData1
        let coords = geoData.geometry.coordinates
        let ngj = {
          type: 'Feature',
          geometry: { type: 'Polygon', coordinates:
              (geoData.geometry.type === 'LineString') ? Array.of(coords) : coords,
          },
          properties: {
            eocrom: { 'csx': 0, 'cf': 666, 'cs': 666, 'cw': 0.8, 'co': 0.01, 'cp': 0.99},
          },
        }
        return ngj
      },
      eomot: {
        proform: {
          projection: 'uniwen',
          prerotate: [[[ ctl.rotation ]]],
          scale: 1,
          translate: [ 200, 0 ],
          rotate: [ 0, 0, 0 ],
        },
      },
      eocrom: {'csx': 0, 'cf': 555, 'cs': 111, 'cw': 0.9, 'co': 0.072, 'cp': 0.7},
      eoload: {},
    }
    // .................. lichtAni2
    let lichtAni2 = {

      eohal: 'mars',
      eotim: eotim,
      eoric: { gid: 'ani', cid: 'ani', fid: 'ani2'},

      eofold: ani => {
        let geoData = geoData2
        let coords = geoData.geometry.coordinates
        let ngj = {
          type: 'Feature',
          geometry: { type: 'Polygon', coordinates:
              (geoData.geometry.type === 'LineString') ? Array.of(coords) : coords,
          },
          properties: {
            eocrom: { 'csx': 0, 'cf': 666, 'cs': 666, 'cw': 0.8, 'co': 0.01, 'cp': 0.99},
          },
        }
        return ngj
      },
      eomot: {
        proform: {
          projection: 'uniwen',
          translate: [-100, 0],
          scale: [1, 1],
          rotate: [ 0, 0, 0 ],
          lens: [0, 1, Infinity],
        },
      },
      eocrom: {'csx': 0, 'cf': 555, 'cs': 111, 'cw': 0.9, 'co': 0.072, 'cp': 0.7},
      eoload: {},
    }
    // .................. natB
    let natAB = {

      eohal: eohalMars,
      eotim: eotim,
      eoric: {gid: 'nat', cid: 'nat', fid: 'natAB'},

      eofold: ani => {
        let uniframe = {start: 0, stop: 0.9, step: ani.eoload.step}

        let gjdata1 = muonCastel.castels(svgdata1, uniframe)
        let geoData1 = muonProj3ct(gjdata1, muonProfier.uniweon(proformSvg1))
        let A = geoData1.geometry.coordinates

        let gjdata2 = muonCastel.castels(svgdata2, uniframe)
        let geoData2 = muonProj3ct(gjdata2, muonProfier.uniweon(proformSvg2))
        let B = geoData2.geometry.coordinates

        let sum = muonMinkowski(A, B, ani.eoload.sa, ani.eoload.sb)
        let sumring = [...sum, sum[0]]

        let res = {
          type: 'Feature',
          geometry: {
            type: 'MultiLineString',
            coordinates: [sumring],
          },
          properties: {},
        }

        return res
      },
      eonode: {
        type: 'Feature',
        geometry: {type: 'Point', coordinates: [0, 0, 0]},
        properties: {orgen: [0, 0, 0], velin: [0, 0, 0], prevous: [0, 0, 0], geodelta: [0, 0, 0]},
      },
      eomot: {
        proform: {
          projection: 'uniwen',
          prerotate: [[[ ctl.rotation ]]],
          scale: 1,
          translate: [ 50, 0 ],
          rotate: [ 0, 0, 0 ],
        },
      },

      eocrom: { 'csx': 0, 'cf': [[[999, 555, 222, 555, 999]]], 'co': 0.99, 'cs': [[[999, 555, 222, 555, 999]]],
        'cw': 2.99, 'cp': 0.99 },
      eoload: {
        step: [[[0.09, 0.9, 0.9, 0.9, 0.09, 0.9, 0.9, 0.9, 0.01]]],
        sa: [[[0, 0, 0.5, 1, 1, 1, 0.5, 0, 0]]],
        sb: [[[1, 1, 0.5, 0, 0, 0, 0.5, 1, 1]]],
      },
    }
    // .................. animas
    let animas = [

      lichtAni1, // h.sol
      lichtAni2, // h.sol
      natAB, // h.sol

    ]

    return animas
  }

  let enty = () => {}
  enty.ani = ani
  return enty
}
</script>
