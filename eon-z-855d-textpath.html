<script src="eon-x-eonify.js"></script>
<script>
window.xEonify.eon({anitem, time: undefined})

// ... ** **
// ... # license
// ... MIT

// .................. anitem
async function anitem (__eo) {
  // .................. eons
  let [
    ctlWen,
    eohalMars,
    eohalTextform,
    muonNatform,
    muonProps,
    renderSvg,
  ] = await Promise.all([
    __eo('xs').c('wen'),
    __eo('xs').e('mars'),
    __eo('xs').e('textform'),
    __eo('xs').m('natform'),
    __eo('xs').m('props'),
    __eo('xs').r('svg'),
  ])

  ctlWen.control(renderSvg.svg())

  let ani = function () {
    // .................. pics
    let ctl
    try {
      ctl = ctlWen().control(renderSvg.svg())
    } catch (e) {
      ctl = () => [0, 0, 0]
    }

    let radians = Math.PI / 180, degrees = 180 / Math.PI,
      sin = Math.sin, cos = Math.cos, sqrt = Math.sqrt
    let cosh = Math.cosh,
      sinh = Math.sinh
    let epsilon = 1e-5


    let eotim = {'td': 12800, 't0': 0, 't1': 1, 't2': 1, 't3': 1, nostop: 1, tp: t => Math.sin((Math.PI / 2) * t)}

    let conform0 = {
      x: {
        'm1': 4, 'm2': 4, 'n1': 2, 'n2': 2, 'n3': 2, 'a': 1, 'b': 1, // circ
        'ra2': 106, 'v0': 0, 'v1': 1, 'w4': 0, 'seg5': 18, 'pa6': 0, 'pb7': -1,
        // 'dom3': [0, 360],
        // 'dom3': [ [[[0, 120]]], [[[7 * 360, 7 * 360 + 120]]] ],
        'dom3': [ 0, 7 * 360 ],
        'fn0': (e, c) => e[0],
      },
      y: {
        'm1': 4, 'm2': 4, 'n1': 2, 'n2': 2, 'n3': 2, 'a': 1, 'b': 1, // circ
        'ra2': 106, 'v0': 0, 'v1': 1, 'w4': 0, 'seg5': 18, 'pa6': 0, 'pb7': -1,
        'dom3': [0, 360],
        'fn0': (e, c) => 0.1 * sin(e[0]),

      },
    }


    let eocrom = { 'csx': 7, 'cf': [[[ 999, 999, 999]]], 'co': [[[0.9, 0.9, 0.9]]],
      'cs': [[[999, 999, 999]]], 'cw': [[[0.1, 0.1, 0.1]]], 'cp': [[[0.99, 0.99]]]}

    // ............................. textAni
let text = `Hard steel succeeded then:
And stubborn as the metal, were the men.
Truth, modesty, and shame, the world forsook:
Fraud, avarice, and force, their places took.
Then sails were spread, to every wind that blew.
Raw were the sailors, and the depths were new:
Trees, rudely hollow'd, did the waves sustain;
E're ships in triumph plough'd the watry plain.`



    let textAni = {
      eohal: 'textform',
      eotim,
      eoric: {gid: 'txtg', cid: 'txtc0', fid: 'txtf0'},

      eofold: ani => {
        let natipros = {
          eoform: ani.eoform,
          ghv: 1, // horizontal geodesics
          gsa: 1, // asymetric distribution of geodesics around the origin
          gco: 0, // open line
        }

        let res = muonNatform.natMultiLineString(natipros) // Feature.LineString

        return res
      },
      eomot: {
        proform: {
          projection: 'uniwen',
          scale: [ 0.2, 0.2 ],
          prerotate: [[[ ctl.rotation ]]],
          translate: [ -250, 0, 0 ],
          rotate: [0,0,0], // [ [[[0,0]]], [[[270,360]]], [[[0,0]]] ],
          lens: [0, 1, Infinity ],
        },
      },
      eocrom: eocrom,
      eoform: conform0,
      eoload: {
        textform: {
          string: [[[ t => {

            let s = text
            let a = Array.from(s)
            let q = a.length
            let n = Math.ceil(q * t)


            let v =  a.slice(0,n)


            let s1 = v.join('')

            return s1
          }
          ]]],
          style: {
            rotate: [[[ 0, 0 ]]],

            // eocrom
            // 'fill': "rgb(255, 215, 0)",
            // 'fill-opacity': 1,
            // 'stroke': "rgb(255, 215, 0)",
            // 'stroke-width': 0.1,
            // 'stroke-opacity': undefined,

            // 'dx': 444,
            // 'dy': 444,
            'font-size': [[[24, 24]]],
            'font-family': 'Verdana', // BankFuturistic, Arial
            // 'height': 56,
            'kerning': 4, // 1
            'lengthAdjust': 'spacing',  // spacingAndGlyphs
            'letter-spacing': 1,
            'text-anchor': 'start',  // start, middle, end
            'textLength': 0,
            // 'width': 111,
            'word-spacing': 1,
            // 'writing-mode': 'tb',


          },
        },

      },
    }


    let getanis =   function(txt='') {
      let anis = {}
      let a = txt.split('\n')
      for (let i=0; i<a.length; i++) {
        
        let ani = muonProps.clone(textAni)
        ani.eoric.fid = textAni.eoric.fid + '_' + i
        ani.eoric.cid = textAni.eoric.cid + '_' + i
        ani.eomot.proform.translate = [-250, 150 - 35 * i]
        ani.eoload.textform.string = a[i]
        
        anis['ani'+ '_' + i] = ani
      }
      if (1 && 1) console.log('anis', anis)

      return anis
    }
    
    // .................. animas
    let scene = getanis(text)
    return scene
  }

  let enty = () => {}
  enty.ani = ani
  return enty
}
</script>
