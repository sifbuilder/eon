<!DOCTYPE html>
<meta charset="utf-8">
<title>animas</title>
<head >

  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
    div#fps,svg { position: fixed; top:0; left:0; color: white; }
  </style>

</head>
<body style="cursor:crosshair"></body>

<script src="eon-x-d3-require.js"></script>
<script src="eon-x-mapper.js"></script>
<script src="eon-x-s.js"></script>

<script>

;(async function eon () {
  let __mapper = xMapper.xMapper() // init mapper
  __mapper({'xD3Require': xD3Require}) // map require
  __mapper({'xs': xs.xs(__mapper)}) // map x.s

  let muonStore = await __mapper('xs').m('store') // map store
  let muonAnimation = await __mapper('xs').m('animation') // map animation

  let xanimas = await zindex(__mapper)
  let animas = xanimas.animas() // get animas

  muonStore.apply({type: 'UPDANIMA', animas: animas}) // upd animas
  muonAnimation.animate() // animate
})()

// .................. zindex
async function zindex (__mapper) {
  // .................. eons
  let [
    mprops,
    cwen,
    mnat,
    mgeom,
    mgraticule,
    topojson,
    dworldTopo110m,    
  ] = await Promise.all([
    __mapper('xs').m('props'),
    __mapper('xs').c('wen'),
    __mapper('xs').m('nat'),
    __mapper('xs').m('geom'),
    __mapper('xs').m('graticule'),
    __mapper('xs').b('topojson'),
    __mapper('xs').d('worldTopo110m'),    
  ])

  // .................. animas
  let animas = function () {
  let tim = {'td': 18200, 't0': 0, 't1': 1000, 't2': 1, 't3': 1}

  let proform = {

    'projection': 'hedrals',
    'scale': 30,
    'rotate': [ [[[0, -60]]], [[[0, -60]]], [[[0, -60]]] ],
    'translate': [ 0, 0 ],

    'trees': [
      [-1, 4, 5, 2, 0, 1],
      [-1, 4, 5, 0, 0, 1],
      [-1, 0, 0, 0, 0, 4],

      [-1, 2, 3, 0, 1, 4],
      [-1, 2, 0, 2, 1, 1],
      [-1, 0, 1, 2, 1, 2],
      [-1, 4, 1, 2, 0, 3],
      [-1, 0, 1, 2, 1, 2],
      [-1, 0, 1, 2, 0, 2],
      [-1, 0, 1, 5, 0, 2]
    ],
    'treeidx': [[[0, 9.1, 0]]],
    'faciaRotation': [[[Math.PI / 1, Math.PI / 1]]],

    'vertices': [
      [-1, -1, 1], // 0  // 0
      [ 1, -1, 1], // 1  // 1
      [ 1, 1, 1], // 2  // 2
      [-1, 1, 1], // 3  // 3
      [-1, -1, -1], // 5  // 4
      [ 1, -1, -1], // 4  // 5
      [ 1, 1, -1], // 7  // 6
      [-1, 1, -1] // 6  // 7
    ].map(mgeom.normalize) // eg. [0.5773, -0.577, 0.5773]
      .map(mgeom.spherical) // eg. [-0.7853, 0.6154]
      .map(mgeom.to_degrees),

    'faces': [
      [1, 0, 3, 2, 1], // N
      [1, 2, 6, 5, 1],
      [2, 3, 7, 6, 2],
      [3, 0, 4, 7, 3],
      [0, 1, 5, 4, 0],
      [5, 6, 7, 4, 5] // S
    ],

    'control': 'versor'

  }

    // ............................. geograt
  let geograt = {

    halo: 'ent',
      geofold: anitem => mgraticule.vhMultiLine(anitem.payload.graticule),

    payload: {
      tim: tim,
      ric: {'gid': 'geograt', 'cid': 'geograt', 'fid': 'geograt'},
      boform: { 'csx': 0, 'cf': [[[111, 111]]], 'cs': 666, 'cw': 0.39, 'co': [[[0.5, 0.5]]], 'cp': [[[0.9, 0.9]]]},

      proform: proform,

      graticule: {

        'frame': [ [ [-180, 180, 45, 45], [-90, 90, 22.5, 22.5] ],
                  [	[-180, 180, 45, 45], [-90, 90, 22.5, 22.5] ] ]

      }

    }

  }

    // ............................. geoearth
  let geoearth = {

    halo: 'ent',

      geofold: p => {
        let geometry = Object.assign({},
          topojson.mesh(
            dworldTopo110m.data(),
            dworldTopo110m.data().objects.land
          )
        )
        return { type: 'Feature', geometry: geometry, properties: {} }
      },

    payload: {
      tim: tim,
      ric: {'gid': 'geoearth', 'cid': 'geoearth', 'fid': 'geoearth'},
      boform: { 'csx': 0, 'cf': [[[555, 333, 555, 333, 555, 333, 555]]], 'cs': 333, 'cw': 0.2, 'co': 0.4, 'cp': 0.9},

      conform: proform
    }
  }

  // -------------------------------  geoearth
  let geoshpere = {

    halo: 'ent',

    geofold: {
      type: 'Feature',
      geometry: {
        type: 'Sphere'
      },
      properties: {}
    },

    payload: {
      tim: tim,
      ric: {'gid': 'geoshpere', 'cid': 'geoshpere', 'fid': 'geoshpere'},
      boform: { 'csx': 0, 'cf': 444, 'cs': 333, 'cw': 0.9, 'co': 0.4, 'cp': 0.9},
      proform: proform
    }

  }


  // -------------------------------  text
  let text = {


      halo: 'textform',
      geofold: null,
      payload: {

        tim: tim,
        ric: {'gid': 'text', 'cid': 'text', 'fid': 'text'},
        boform: { 'csx': 0, 'cf': [[[888, 777]]], 'cs': 111, 'cw': [[[0.1, 0.7]]], 'co': [[[0.6, 0.99]]], 'cp': [[[0.5, 0.5]]]},

        proform: {
          projection: 'uniwen',
          translate: [ -250, 0 ],
        },

        textform: {
          string: 'nine realms unified by the world tree yggdrasil.',
          style: {
            rotate: [[[ 0, -1 ]]],
            'font-size': [[[10, 60]]],
            'font-family': 'BankFuturistic',
            'text-anchor': 'center',

          },
        },

      },
  }
  
    // ............................. animas
  let animas = [
    geograt, // h.ent g.hedrals
    geoearth, // h.ent g.hedrals
    geoshpere, // h.ent g.hedrals

    text // h.text
  ]

    return animas
  }

  let enty = () => {}
  enty.animas = animas
  return enty
}
</script>